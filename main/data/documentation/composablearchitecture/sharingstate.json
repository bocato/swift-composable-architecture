{"abstract":[{"type":"text","text":"Learn techniques for sharing state throughout many parts of your application, and how to persist"},{"text":" ","type":"text"},{"type":"text","text":"data to user defaults, the file system, and other external mediums."}],"variants":[{"traits":[{"interfaceLanguage":"swift"}],"paths":["\/documentation\/composablearchitecture\/sharingstate"]}],"sections":[],"topicSections":[{"anchor":"Essentials","identifiers":["doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared"],"title":"Essentials"},{"title":"Persistence strategies","identifiers":["doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/AppStorageKey","doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/FileStorageKey","doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/InMemoryKey"],"anchor":"Persistence-strategies"},{"title":"Custom persistence","identifiers":["doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceKey"],"anchor":"Custom-persistence"},{"identifiers":["doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharedReader","doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey"],"anchor":"Read-only-persistence","title":"Read-only persistence"},{"title":"Default values","identifiers":["doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceKeyDefault"],"anchor":"Default-values"}],"seeAlsoSections":[{"title":"Essentials","generated":true,"identifiers":["doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/GettingStarted","doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/DependencyManagement","doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Navigation","doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Performance","doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/FAQ"],"anchor":"Essentials"}],"schemaVersion":{"minor":3,"major":0,"patch":0},"kind":"article","hierarchy":{"paths":[["doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture"],["doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture","doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Reducer"]]},"primaryContentSections":[{"kind":"content","content":[{"level":2,"type":"heading","text":"Overview","anchor":"Overview"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Sharing state is the process of letting many features have access to the same data so that when any"},{"type":"text","text":" "},{"text":"feature makes a change to this data it is instantly visible to every other feature. Such sharing can","type":"text"},{"type":"text","text":" "},{"type":"text","text":"be really handy, but also does not play nicely with value types, which are copied rather than"},{"type":"text","text":" "},{"text":"shared. Because the Composable Architecture highly prefers modeling domains with value types rather","type":"text"},{"type":"text","text":" "},{"type":"text","text":"than reference types, sharing state can be tricky."}]},{"type":"paragraph","inlineContent":[{"text":"This is why the library comes with a few tools for sharing state with many parts of your","type":"text"},{"type":"text","text":" "},{"text":"application. There are two main kinds of shared state in the library: explicitly passed state and","type":"text"},{"type":"text","text":" "},{"type":"text","text":"persisted state. And there are 3 persistence strategies shipped with the library:"},{"type":"text","text":" "},{"isActive":true,"overridingTitleInlineContent":[{"text":"in-memory","type":"text"}],"overridingTitle":"in-memory","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/inMemory(_:)","type":"reference"},{"type":"text","text":","},{"text":" ","type":"text"},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/appStorage(_:)-4l5b","overridingTitle":"user defaults","overridingTitleInlineContent":[{"type":"text","text":"user defaults"}]},{"type":"text","text":", and"},{"type":"text","text":" "},{"overridingTitle":"file storage","overridingTitleInlineContent":[{"type":"text","text":"file storage"}],"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/fileStorage(_:decoder:encoder:)","isActive":true},{"type":"text","text":". You can also implement"},{"type":"text","text":" "},{"type":"text","text":"your own persistence strategy if you want to use something other than user defaults or the file"},{"type":"text","text":" "},{"type":"text","text":"system, such as SQLite."}]},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"reference","isActive":true,"identifier":"#Source-of-truth"}]}]},{"content":[{"inlineContent":[{"isActive":true,"identifier":"#Explicit-shared-state","type":"reference"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"identifier":"#Persisted-shared-state","type":"reference","isActive":true}],"type":"paragraph"},{"items":[{"content":[{"inlineContent":[{"type":"reference","identifier":"#In-memory","isActive":true}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"isActive":true,"type":"reference","identifier":"#User-defaults"}],"type":"paragraph"}]},{"content":[{"inlineContent":[{"identifier":"#File-storage","isActive":true,"type":"reference"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"identifier":"#Custom-persistence","isActive":true,"type":"reference"}]}]}],"type":"unorderedList"}]},{"content":[{"type":"paragraph","inlineContent":[{"isActive":true,"type":"reference","identifier":"#Observing-changes-to-shared-state"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"identifier":"#Initialization-rules","isActive":true,"type":"reference"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"reference","identifier":"#Deriving-shared-state","isActive":true}]}]},{"content":[{"inlineContent":[{"type":"reference","isActive":true,"identifier":"#Testing"}],"type":"paragraph"},{"type":"unorderedList","items":[{"content":[{"type":"paragraph","inlineContent":[{"type":"reference","isActive":true,"identifier":"#Testing-when-using-persistence"}]}]},{"content":[{"inlineContent":[{"identifier":"#Testing-when-using-custom-persistence-strategies","isActive":true,"type":"reference"}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"isActive":true,"type":"reference","identifier":"#Overriding-shared-state-in-tests"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"isActive":true,"type":"reference","identifier":"#UI-Testing"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"identifier":"#Testing-tips","type":"reference","isActive":true}]}]}]}]},{"content":[{"type":"paragraph","inlineContent":[{"isActive":true,"type":"reference","identifier":"#Read-only-shared-state"}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"reference","identifier":"#Type-safe-keys","isActive":true}]}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"reference","identifier":"#Concurrent-mutations-to-shared-state","isActive":true}]}]},{"content":[{"inlineContent":[{"type":"reference","identifier":"#Shared-state-in-pre-observation-apps","isActive":true}],"type":"paragraph"}]},{"content":[{"type":"paragraph","inlineContent":[{"type":"reference","identifier":"#Gotchas-of-Shared","isActive":true}]}]}]},{"text":"“Source of truth”","anchor":"Source-of-truth","type":"heading","level":2},{"type":"paragraph","inlineContent":[{"text":"First a quick discussion on defining exactly what “shared state” is. A common concept thrown around","type":"text"},{"type":"text","text":" "},{"type":"text","text":"in architectural discussions is “single source of truth.” This is the idea that the complete state"},{"text":" ","type":"text"},{"type":"text","text":"of an application, even its navigation, can be driven off a single piece of data. It’s a great idea,"},{"type":"text","text":" "},{"type":"text","text":"in theory, but in practice it can be quite difficult to completely embrace."}]},{"type":"paragraph","inlineContent":[{"text":"First of all, a ","type":"text"},{"type":"emphasis","inlineContent":[{"type":"text","text":"single"}]},{"type":"text","text":" piece of data to drive "},{"inlineContent":[{"text":"all","type":"text"}],"type":"emphasis"},{"text":" of application state is just not feasible.","type":"text"},{"text":" ","type":"text"},{"text":"There is a lot of state in an application that is fine to be local to a view and does not need","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"global representation. For example, the state of whether a button is being pressed is probably fine"},{"text":" ","type":"text"},{"text":"to reside privately inside the button.","type":"text"}]},{"inlineContent":[{"text":"And second, applications typically do not have a ","type":"text"},{"inlineContent":[{"text":"single","type":"text"}],"type":"emphasis"},{"text":" source of truth. That is far too","type":"text"},{"type":"text","text":" "},{"text":"simplistic. If your application loads data from an API, or from disk, or from user defaults, then","type":"text"},{"text":" ","type":"text"},{"text":"the “truth” for that data does not lie in your application. It lies externally.","type":"text"}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"type":"text","text":"In reality, there are "},{"inlineContent":[{"text":"two","type":"text"}],"type":"emphasis"},{"type":"text","text":" sources of “truth” in any application. There is the state the"},{"type":"text","text":" "},{"text":"application needs to execute its logic and behavior. This is the kind of state that determines if a","type":"text"},{"type":"text","text":" "},{"type":"text","text":"button is enabled or disabled, drives navigation such as sheets and drill-downs, and handles"},{"text":" ","type":"text"},{"type":"text","text":"validation of forms. Such state only makes sense for the application."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Then there is a second source of “truth” in an application, which is the data that lies in some"},{"type":"text","text":" "},{"text":"external system and needs to be loaded into the application. Such state is best modeled as a","type":"text"},{"type":"text","text":" "},{"type":"text","text":"dependency or using the shared state tools discussed in this article."}]},{"text":"Explicit shared state","type":"heading","level":2,"anchor":"Explicit-shared-state"},{"type":"paragraph","inlineContent":[{"text":"This is the simplest kind of shared state to get started with. It allows you to share state amongst","type":"text"},{"text":" ","type":"text"},{"text":"many features without any persistence. The data is only held in memory, and will be cleared out the","type":"text"},{"text":" ","type":"text"},{"text":"next time the application is run.","type":"text"}]},{"type":"paragraph","inlineContent":[{"text":"To share data in this style, use the ","type":"text"},{"overridingTitle":"@Shared","overridingTitleInlineContent":[{"code":"@Shared","type":"codeVoice"}],"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared","isActive":true},{"type":"text","text":" property wrapper with no arguments."},{"type":"text","text":" "},{"text":"For example, suppose you have a feature that holds a count and you want to be able to hand a shared","type":"text"},{"type":"text","text":" "},{"type":"text","text":"reference to that count to other features. You can do so by holding onto a "},{"code":"@Shared","type":"codeVoice"},{"type":"text","text":" property in"},{"text":" ","type":"text"},{"type":"text","text":"the feature’s state:"}]},{"syntax":"swift","code":["@Reducer","struct ParentFeature {","  @ObservableState","  struct State {","    @Shared var count: Int","    \/\/ Other properties","  }","  \/\/ ...","}"],"type":"codeListing"},{"type":"aside","style":"important","name":"Important","content":[{"inlineContent":[{"text":"It is not possible to provide a default to a ","type":"text"},{"code":"@Shared","type":"codeVoice"},{"type":"text","text":" value. It must be passed to the"},{"type":"text","text":" "},{"text":"feature’s state from the outside. See ","type":"text"},{"isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState#Initialization-rules","type":"reference"},{"type":"text","text":" for more"},{"text":" ","type":"text"},{"text":"information about how to initialize types that use ","type":"text"},{"type":"codeVoice","code":"@Shared"},{"text":".","type":"text"}],"type":"paragraph"}]},{"inlineContent":[{"type":"text","text":"Then suppose that this feature can present a child feature that wants access to this shared "},{"code":"count","type":"codeVoice"},{"type":"text","text":" "},{"type":"text","text":"value. It too would hold onto a "},{"type":"codeVoice","code":"@Shared"},{"text":" property to a count:","type":"text"}],"type":"paragraph"},{"code":["@Reducer","struct ChildFeature {","  @ObservableState","  struct State {","    @Shared var count: Int","    \/\/ Other properties","  }","  \/\/ ...","}"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"When the parent features creates the child feature’s state, it can pass a "},{"type":"emphasis","inlineContent":[{"text":"reference","type":"text"}]},{"text":" to the shared","type":"text"},{"text":" ","type":"text"},{"text":"count rather than the actual count value by using the ","type":"text"},{"type":"codeVoice","code":"$count"},{"text":" ","type":"text"},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/projectedValue","isActive":true,"type":"reference"},{"text":":","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["case .presentButtonTapped:","  state.child = ChildFeature.State(count: state.$count)","  \/\/ ..."]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Now any mutation the "},{"code":"ChildFeature","type":"codeVoice"},{"text":" makes to its ","type":"text"},{"type":"codeVoice","code":"count"},{"type":"text","text":" will be instantly made to the"},{"text":" ","type":"text"},{"type":"codeVoice","code":"ParentFeature"},{"text":"’s count too.","type":"text"}]},{"type":"heading","level":2,"anchor":"Persisted-shared-state","text":"Persisted shared state"},{"inlineContent":[{"text":"Explicitly shared state discussed above is a nice, lightweight way to share a piece of data with","type":"text"},{"type":"text","text":" "},{"type":"text","text":"many parts of your application. However, sometimes you want to share state with the entire"},{"text":" ","type":"text"},{"text":"application without having to pass it around explicitly. One can do this by passing a","type":"text"},{"text":" ","type":"text"},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceKey"},{"text":" to the ","type":"text"},{"code":"@Shared","type":"codeVoice"},{"text":" property wrapper, and the library comes with three persistence","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"strategies, as well as the ability to create custom persistence strategies."}],"type":"paragraph"},{"anchor":"In-memory","text":"In-memory","type":"heading","level":4},{"type":"paragraph","inlineContent":[{"text":"This is the simplest persistence strategy in that it doesn’t actually persist at all. It keeps","type":"text"},{"type":"text","text":" "},{"type":"text","text":"the data in memory and makes it available to every part of the application, but when the app is"},{"text":" ","type":"text"},{"type":"text","text":"relaunched the data will be reset back to its default."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"It can be used by passing "},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/inMemory(_:)"},{"type":"text","text":" to the "},{"code":"@Shared","type":"codeVoice"},{"type":"text","text":" property wrapper."},{"text":" ","type":"text"},{"type":"text","text":"For example, suppose you want to share an integer count value with the entire application so that"},{"type":"text","text":" "},{"type":"text","text":"any feature can read from and write to the integer. This can be done like so:"}]},{"syntax":"swift","type":"codeListing","code":["@Reducer","struct ChildFeature {","  @ObservableState","  struct State {","    @Shared(.inMemory(\"count\")) var count = 0","    \/\/ Other properties","  }","  \/\/ ...","}"]},{"style":"note","type":"aside","name":"Note","content":[{"inlineContent":[{"type":"text","text":"When using a persistence strategy with "},{"code":"@Shared","type":"codeVoice"},{"type":"text","text":" you must provide a default value, which is"},{"text":" ","type":"text"},{"text":"used for the first access of the shared state.","type":"text"}],"type":"paragraph"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Now any part of the application can read from and write to this state, and features will never"},{"text":" ","type":"text"},{"type":"text","text":"get out of sync."}]},{"type":"heading","text":"User defaults","anchor":"User-defaults","level":4},{"type":"paragraph","inlineContent":[{"text":"If you would like to persist your shared value across application launches, then you can use the","type":"text"},{"type":"text","text":" "},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/appStorage(_:)-4l5b","type":"reference","isActive":true},{"text":" strategy with ","type":"text"},{"type":"codeVoice","code":"@Shared"},{"type":"text","text":" in order to automatically"},{"text":" ","type":"text"},{"text":"persist any changes to the value to user defaults. It works similarly to in-memory sharing discussed","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"above. It requires a key to store the value in user defaults, as well as a default value that will"},{"type":"text","text":" "},{"text":"be used when there is no value in the user defaults:","type":"text"}]},{"code":["@Shared(.appStorage(\"count\")) var count = 0"],"type":"codeListing","syntax":"swift"},{"type":"paragraph","inlineContent":[{"type":"text","text":"That small change will guarantee that all changes to "},{"type":"codeVoice","code":"count"},{"text":" are persisted and will be","type":"text"},{"text":" ","type":"text"},{"text":"automatically loaded the next time the application launches.","type":"text"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"This form of persistence only works for simple data types because that is what works best with"},{"text":" ","type":"text"},{"code":"UserDefaults","type":"codeVoice"},{"type":"text","text":". This includes strings, booleans, integers, doubles, URLs, data, and more. If you"},{"text":" ","type":"text"},{"type":"text","text":"need to store more complex data, such as custom data types serialized to JSON, then you will want"},{"text":" ","type":"text"},{"text":"to use the ","type":"text"},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState#File-storage","type":"reference","overridingTitle":".fileStorage","overridingTitleInlineContent":[{"type":"codeVoice","code":".fileStorage"}],"isActive":true},{"text":" strategy or a","type":"text"},{"type":"text","text":" "},{"overridingTitleInlineContent":[{"type":"text","text":"custom persistence"}],"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState#Custom-persistence","overridingTitle":"custom persistence"},{"type":"text","text":" strategy."}]},{"type":"heading","text":"File storage","anchor":"File-storage","level":4},{"type":"paragraph","inlineContent":[{"type":"text","text":"If you would like to persist your shared value across application launches, and your value is"},{"type":"text","text":" "},{"type":"text","text":"complex (such as a custom data type), then you can use the "},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/fileStorage(_:decoder:encoder:)","isActive":true,"type":"reference"},{"text":" ","type":"text"},{"text":"strategy with ","type":"text"},{"type":"codeVoice","code":"@Shared"},{"text":". It automatically persists any changes to the file system.","type":"text"}]},{"inlineContent":[{"type":"text","text":"It works similarly to the in-memory sharing discussed above, but it requires a URL to store the data"},{"text":" ","type":"text"},{"type":"text","text":"on disk, as well as a default value that will be used when there is no data in the file system:"}],"type":"paragraph"},{"code":["@Shared(.fileStorage(URL(\/* ... *\/)) var users: [User] = []"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"This strategy works by serializing your value to JSON to save to disk, and then deserializing JSON"},{"text":" ","type":"text"},{"text":"when loading from disk. For this reason the value held in ","type":"text"},{"type":"codeVoice","code":"@Shared(.fileStorage(…))"},{"text":" must conform to","type":"text"},{"type":"text","text":" "},{"code":"Codable","type":"codeVoice"},{"text":".","type":"text"}]},{"text":"Custom persistence","anchor":"Custom-persistence","type":"heading","level":4},{"inlineContent":[{"type":"text","text":"It is possible to define all new persistence strategies for the times that user defaults or JSON"},{"type":"text","text":" "},{"type":"text","text":"files are not sufficient. To do so, define a type that conforms to the "},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceKey","type":"reference","isActive":true},{"type":"text","text":" protocol:"}],"type":"paragraph"},{"code":["public final class CustomPersistenceKey: PersistenceKey {","  \/\/ ...","}"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"text":"And then define a static function on the ","type":"text"},{"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceKey","isActive":true},{"text":" protocol for creating your new","type":"text"},{"type":"text","text":" "},{"type":"text","text":"persistence strategy:"}],"type":"paragraph"},{"type":"codeListing","code":["extension PersistenceReaderKey {","  public static func custom<Value>(\/*...*\/) -> Self","  where Self == CustomPersistence<Value> {","    CustomPersistence(\/* ... *\/)","  }","}"],"syntax":"swift"},{"type":"paragraph","inlineContent":[{"text":"With those steps done you can make use of the strategy in the same way one does for","type":"text"},{"type":"text","text":" "},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/appStorage(_:)-4l5b"},{"type":"text","text":" and "},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/fileStorage(_:decoder:encoder:)","isActive":true,"type":"reference"},{"text":":","type":"text"}]},{"code":["@Shared(.custom(\/* ... *\/)) var myValue: Value"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"type":"text","text":"The "},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceKey"},{"type":"text","text":" protocol represents loading from "},{"inlineContent":[{"type":"text","text":"and"}],"type":"emphasis"},{"type":"text","text":" saving to some external storage,"},{"type":"text","text":" "},{"text":"such as the file system or user defaults. Sometimes saving is not a valid operation for the external","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"system, such as if your server holds onto a remote configuration file that your app uses to"},{"text":" ","type":"text"},{"type":"text","text":"customize its appearance or behavior. In those situations you can conform to the"},{"type":"text","text":" "},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey"},{"type":"text","text":" protocol. See "},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState#Read-only-shared-state"},{"type":"text","text":" for more"},{"type":"text","text":" "},{"type":"text","text":"information."}],"type":"paragraph"},{"text":"Observing changes to shared state","anchor":"Observing-changes-to-shared-state","level":2,"type":"heading"},{"type":"paragraph","inlineContent":[{"text":"The ","type":"text"},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared"},{"type":"text","text":" property wrapper exposes a "},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/publisher"},{"type":"text","text":" property so that you can observe"},{"type":"text","text":" "},{"type":"text","text":"changes to the reference from any part of your application. For example, if some feature in your"},{"type":"text","text":" "},{"type":"text","text":"app wants to listen for changes to some shared "},{"code":"count","type":"codeVoice"},{"type":"text","text":" value, then it can introduce an "},{"type":"codeVoice","code":"onAppear"},{"type":"text","text":" "},{"type":"text","text":"action that kicks off a long-living effect that subscribes to changes of "},{"type":"codeVoice","code":"count"},{"type":"text","text":":"}]},{"type":"codeListing","syntax":"swift","code":["case .onAppear:","  return .publisher {","    state.$count.publisher","      .map(Action.countUpdated)","  }","","case .countUpdated(let count):","  \/\/ Do something with count","  return .none"]},{"type":"paragraph","inlineContent":[{"text":"Note that you will have to be careful for features that both hold onto shared state and subscribe","type":"text"},{"type":"text","text":" "},{"text":"to changes to that state. It is possible to introduce an infinite loop if you do something like","type":"text"},{"text":" ","type":"text"},{"text":"this:","type":"text"}]},{"code":["case .onAppear:","  return .publisher {","    state.$count.publisher","      .map(Action.countUpdated)","  }","","case .countUpdated(let count):","  state.count = count + 1","  return .none"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"text":"If ","type":"text"},{"type":"codeVoice","code":"count"},{"text":" changes, then ","type":"text"},{"code":"$count.publisher","type":"codeVoice"},{"text":" emits, causing the ","type":"text"},{"code":"countUpdated","type":"codeVoice"},{"type":"text","text":" action to be sent,"},{"type":"text","text":" "},{"text":"causing the shared ","type":"text"},{"code":"count","type":"codeVoice"},{"type":"text","text":" to be mutated, causing "},{"type":"codeVoice","code":"$count.publisher"},{"text":" to emit, and so on.","type":"text"}],"type":"paragraph"},{"text":"Initialization rules","level":2,"anchor":"Initialization-rules","type":"heading"},{"type":"paragraph","inlineContent":[{"text":"Because the state sharing tools use property wrappers there are special rules that must be followed","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"when writing custom initializers for your types. These rules apply to "},{"type":"emphasis","inlineContent":[{"type":"text","text":"any"}]},{"text":" kind of property","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"wrapper, including those that ship with vanilla SwiftUI (e.g. "},{"code":"@State","type":"codeVoice"},{"type":"text","text":", "},{"type":"codeVoice","code":"@StateObject"},{"type":"text","text":", etc.),"},{"type":"text","text":" "},{"type":"text","text":"but the rules can be quite confusing and so below we describe the various ways to initialize"},{"text":" ","type":"text"},{"type":"text","text":"shared state."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"It is common to need to provide a custom initializer to your feature’s"},{"text":" ","type":"text"},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Reducer\/State"},{"text":" type, especially when modularizing. When using","type":"text"},{"text":" ","type":"text"},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared","isActive":true,"overridingTitleInlineContent":[{"code":"@Shared","type":"codeVoice"}],"type":"reference","overridingTitle":"@Shared"},{"text":" in your ","type":"text"},{"code":"State","type":"codeVoice"},{"type":"text","text":" that can become complicated."},{"text":" ","type":"text"},{"type":"text","text":"Depending on your exact situation you can do one of the following:"}]},{"type":"unorderedList","items":[{"content":[{"inlineContent":[{"type":"text","text":"You are using non-persisted shared state (i.e. no argument is passed to "},{"code":"@Shared","type":"codeVoice"},{"type":"text","text":"), and the"},{"text":" ","type":"text"},{"text":"“source of truth” of the state lives with the parent feature. Then the initializer should take a","type":"text"},{"text":" ","type":"text"},{"type":"codeVoice","code":"Shared"},{"type":"text","text":" value and you can assign through the underscored property:"}],"type":"paragraph"},{"code":["public struct State {","  @Shared public var count: Int","  \/\/ other fields","","  public init(count: Shared<Int>, \/* other fields *\/) {","    self._count = count","    \/\/ other assignments","  }","}"],"type":"codeListing","syntax":"swift"}]},{"content":[{"type":"paragraph","inlineContent":[{"text":"You are using non-persisted shared state (","type":"text"},{"inlineContent":[{"type":"text","text":"i.e."}],"type":"emphasis"},{"text":" no argument is passed to ","type":"text"},{"code":"@Shared","type":"codeVoice"},{"text":"), and the","type":"text"},{"type":"text","text":" "},{"text":"“source of truth” of the state lives within the feature you are initializing. Then the initializer","type":"text"},{"text":" ","type":"text"},{"text":"should take a plain, non-","type":"text"},{"code":"Shared","type":"codeVoice"},{"type":"text","text":" value and you construct the "},{"type":"codeVoice","code":"Shared"},{"text":" value in the initializer:","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["public struct State {","  @Shared public var count: Int","  \/\/ other fields","","  public init(count: Int, \/* other fields *\/) {","    self._count = Shared(count)","    \/\/ other assignments","  }","}"]}]},{"content":[{"inlineContent":[{"text":"You are using a persistence strategy with shared state (","type":"text"},{"type":"emphasis","inlineContent":[{"type":"text","text":"e.g."}]},{"text":"","type":"text"},{"type":"text","text":" "},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/appStorage(_:)-4l5b","type":"reference","isActive":true},{"type":"text","text":", "},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/fileStorage(_:decoder:encoder:)"},{"text":", ","type":"text"},{"inlineContent":[{"text":"etc.","type":"text"}],"type":"emphasis"},{"type":"text","text":"),"},{"text":" ","type":"text"},{"type":"text","text":"then the initializer should take a plain, non-"},{"code":"Shared","type":"codeVoice"},{"type":"text","text":" value and you construct the "},{"code":"Shared","type":"codeVoice"},{"text":" value in","type":"text"},{"type":"text","text":" "},{"text":"the initializer using ","type":"text"},{"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/init(wrappedValue:_:fileID:line:)-9kfmy","isActive":true},{"text":" which takes a","type":"text"},{"text":" ","type":"text"},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceKey"},{"type":"text","text":" as the second argument:"}],"type":"paragraph"},{"code":["public struct State {","  @Shared public var count: Int","  \/\/ other fields","","  public init(count: Int, \/* other fields *\/) {","    self._count = Shared(wrappedValue: count, .appStorage(\"count\"))","    \/\/ other assignments","  }","}"],"syntax":"swift","type":"codeListing"},{"inlineContent":[{"type":"text","text":"The declaration of "},{"type":"codeVoice","code":"count"},{"type":"text","text":" can use "},{"code":"@Shared","type":"codeVoice"},{"type":"text","text":" without an argument because the persistence"},{"text":" ","type":"text"},{"type":"text","text":"strategy is specified in the initializer."}],"type":"paragraph"},{"style":"important","type":"aside","name":"Important","content":[{"type":"paragraph","inlineContent":[{"text":"The value passed to this initializer is only used if the external storage does not","type":"text"},{"text":" ","type":"text"},{"text":"already have a value. If a value exists in the storage then it is not used. In fact, the","type":"text"},{"type":"text","text":" "},{"type":"codeVoice","code":"wrappedValue"},{"text":" argument of ","type":"text"},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/init(wrappedValue:_:fileID:line:)-9kfmy"},{"text":" is an","type":"text"},{"type":"text","text":" "},{"code":"@autoclosure","type":"codeVoice"},{"text":" so that it is not even evaluated if not used. For that reason you","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"may prefer to make the argument to the initializer an "},{"type":"codeVoice","code":"@autoclosure"},{"type":"text","text":" so that it too is evaluated"},{"type":"text","text":" "},{"type":"text","text":"only if actually used:"}]},{"syntax":"swift","type":"codeListing","code":["public struct State {","  @Shared public var count: Int","  \/\/ other fields","","  public init(count: @autoclosure () -> Int, \/* other fields *\/) {","    self._count = Shared(wrappedValue: count(), .appStorage(\"count\"))","    \/\/ other assignments","  }","}"]}]}]}]},{"type":"heading","text":"Deriving shared state","anchor":"Deriving-shared-state","level":2},{"type":"paragraph","inlineContent":[{"text":"It is possible to derive shared state for sub-parts of an existing piece of shared state. For","type":"text"},{"type":"text","text":" "},{"type":"text","text":"example, suppose you have a multi-step signup flow that uses "},{"type":"codeVoice","code":"Shared<SignUpData>"},{"type":"text","text":" in order to share"},{"text":" ","type":"text"},{"type":"text","text":"data between each screen. However, some screens may not need all of "},{"code":"SignUpData","type":"codeVoice"},{"text":", but instead just a","type":"text"},{"type":"text","text":" "},{"type":"text","text":"small part. The phone number confirmation screen may only need access to "},{"type":"codeVoice","code":"signUpData.phoneNumber"},{"type":"text","text":","},{"type":"text","text":" "},{"type":"text","text":"and so that feature can hold onto just "},{"code":"Shared<String>","type":"codeVoice"},{"text":" to express this fact:","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["@Reducer ","struct PhoneNumberFeature { ","  struct State {","    @Shared var phoneNumber: String","  }","  \/\/ ...","}"]},{"type":"paragraph","inlineContent":[{"text":"Then, when the parent feature constructs the ","type":"text"},{"type":"codeVoice","code":"PhoneNumberFeature"},{"type":"text","text":" it can derive a small piece of"},{"text":" ","type":"text"},{"type":"text","text":"shared state from "},{"type":"codeVoice","code":"Shared<SignUpData>"},{"type":"text","text":" to pass along:"}]},{"code":["case .nextButtonTapped:","  state.path.append(","    PhoneNumberFeature.State(phoneNumber: state.$signUpData.phoneNumber)","  )"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"text":"Here we are using the ","type":"text"},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/projectedValue","isActive":true,"type":"reference"},{"text":" value using ","type":"text"},{"code":"$","type":"codeVoice"},{"type":"text","text":" syntax, "},{"type":"codeVoice","code":"$signUpData"},{"text":", and then","type":"text"},{"type":"text","text":" "},{"type":"text","text":"further dot-chaining onto that projection to derive a "},{"code":"Shared<String>","type":"codeVoice"},{"text":". This can be a powerful way","type":"text"},{"type":"text","text":" "},{"text":"for features to hold onto only the bare minimum of shared state it needs to do its job.","type":"text"}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"type":"text","text":"It can be instructive to think of "},{"code":"@Shared","type":"codeVoice"},{"text":" as the Composable Architecture analogue of ","type":"text"},{"type":"codeVoice","code":"@Bindable"},{"type":"text","text":" "},{"type":"text","text":"in vanilla SwiftUI. You use it to express that the actual “source of truth” of the value lies"},{"text":" ","type":"text"},{"type":"text","text":"elsewhere, but you want to be able to read its most current value and write to it."}]},{"type":"paragraph","inlineContent":[{"text":"This also works for persistence strategies. If a parent feature holds onto a ","type":"text"},{"code":"@Shared","type":"codeVoice"},{"text":" piece of","type":"text"},{"text":" ","type":"text"},{"text":"state with a persistence strategy:","type":"text"}]},{"type":"codeListing","code":["@Reducer","struct ParentFeature {","  struct State {","    @Shared(.fileStorage(.currentUser)) var currentUser","  }","  \/\/ ...","}"],"syntax":"swift"},{"inlineContent":[{"type":"text","text":"…and a child feature wants access to just a shared "},{"inlineContent":[{"type":"text","text":"piece"}],"type":"emphasis"},{"text":" of ","type":"text"},{"type":"codeVoice","code":"currentUser"},{"type":"text","text":", such as their name,"},{"type":"text","text":" "},{"text":"then they can do so by holding onto a simple, unadorned ","type":"text"},{"code":"@Shared","type":"codeVoice"},{"text":":","type":"text"}],"type":"paragraph"},{"code":["@Reducer","struct ChildFeature {","  struct State {","    @Shared var currentUserName: String","  }","  \/\/ ...","}"],"syntax":"swift","type":"codeListing"},{"inlineContent":[{"type":"text","text":"And then the parent can pass along "},{"code":"$currentUser.name","type":"codeVoice"},{"type":"text","text":" to the child feature when constructing its"},{"type":"text","text":" "},{"type":"text","text":"state:"}],"type":"paragraph"},{"code":["case .editNameButtonTapped:","  state.destination = .editName(","    EditNameFeature(name: state.$currentUser.name)","  )"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"text":"Any changes the child feature makes to its shared ","type":"text"},{"type":"codeVoice","code":"name"},{"text":" will be automatically made to the parent’s","type":"text"},{"type":"text","text":" "},{"type":"text","text":"shared "},{"type":"codeVoice","code":"currentUser"},{"text":", and further those changes will be automatically persisted thanks to the","type":"text"},{"text":" ","type":"text"},{"code":".fileStorage","type":"codeVoice"},{"type":"text","text":" persistence strategy used. This means the child feature gets to describe that it"},{"text":" ","type":"text"},{"text":"needs access to shared state without describing the persistence strategy, and the parent can be","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"responsible for persisting and deriving shared state to pass to the child."}],"type":"paragraph"},{"inlineContent":[{"text":"If your shared state is a collection, and in particular an ","type":"text"},{"code":"IdentifiedArray","type":"codeVoice"},{"text":", then we have another","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"tool for deriving shared state to a particular element of the array. You can subscript into a"},{"type":"text","text":" "},{"isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared","type":"reference"},{"type":"text","text":" collection with the "},{"code":"[id:]","type":"codeVoice"},{"text":" subscript, and that will give a piece of optional shared","type":"text"},{"text":" ","type":"text"},{"text":"state (thanks to a dynamic member overload ","type":"text"},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/subscript(dynamicMember:)-9xw64","isActive":true,"type":"reference"},{"type":"text","text":"), which you"},{"text":" ","type":"text"},{"type":"text","text":"can then unwrap to turn into honest shared state:"}],"type":"paragraph"},{"type":"codeListing","code":["@Shared(.fileStorage(.todos)) var todos: IdentifiedArrayOf<Todo> = []","","guard let todo = $todos[id: todoID]","else { return }","todo \/\/ Shared<Todo>"],"syntax":"swift"},{"type":"paragraph","inlineContent":[{"text":"There is another tool for deriving shared state, and it is the computed property ","type":"text"},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/elements"},{"type":"text","text":" "},{"text":"that is defined on shared collections. It derives a collection of shared elements so that you can","type":"text"},{"type":"text","text":" "},{"type":"text","text":"get access to a shared reference of just one particular element in a collection."}]},{"inlineContent":[{"text":"However, it is only appropriate to use this in conjunction with ","type":"text"},{"type":"codeVoice","code":"ForEach"},{"type":"text","text":" in order to derive a"},{"text":" ","type":"text"},{"type":"text","text":"shared reference for each element of a collection:"}],"type":"paragraph"},{"code":["struct State {","  @Shared(.fileStorage(.todos)) var todos: IdentifiedArrayOf<Todo> = []","  \/\/ ...","}","","\/\/ ...","","ForEach(store.$todos.elements) { $todo in","  NavigationLink(","    \/\/ $todo: Shared<Todo>","    \/\/  todo: Todo","    state: Path.State.todo(TodoFeature.State(todo: $todo))","  ) {","    Text(todo.title)","  }","}"],"syntax":"swift","type":"codeListing"},{"type":"aside","style":"important","name":"Important","content":[{"type":"paragraph","inlineContent":[{"type":"text","text":"We do not recommend using "},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/elements"},{"text":" outside of using it with ","type":"text"},{"type":"codeVoice","code":"ForEach"},{"type":"text","text":","},{"text":" ","type":"text"},{"code":"List","type":"codeVoice"},{"type":"text","text":", and other SwiftUI views that take collections."}]}]},{"level":2,"type":"heading","anchor":"Testing","text":"Testing"},{"inlineContent":[{"text":"Shared state behaves quite a bit different from the regular state held in Composable Architecture","type":"text"},{"type":"text","text":" "},{"type":"text","text":"features. It is capable of being changed by any part of the application, not just when an action is"},{"text":" ","type":"text"},{"text":"sent to the store, and it has reference semantics rather than value semantics. Typically references","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"cause serious problems with testing, especially exhaustive testing that the library prefers (see"},{"type":"text","text":" "},{"type":"text","text":"doc:Testing"},{"type":"text","text":"), because references cannot be copied and so one cannot inspect the changes before and"},{"type":"text","text":" "},{"text":"after an action is sent.","type":"text"}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"For this reason, the "},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared"},{"text":" property wrapper does extra work during testing to preserve a","type":"text"},{"type":"text","text":" "},{"type":"text","text":"previous snapshot of the state so that one can still exhaustively assert on shared state, even"},{"text":" ","type":"text"},{"type":"text","text":"though it is a reference."}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"For the most part, shared state can be tested just like any regular state held in your features. For"},{"text":" ","type":"text"},{"type":"text","text":"example, consider the following simple counter feature that uses in-memory shared state for the"},{"type":"text","text":" "},{"text":"count:","type":"text"}],"type":"paragraph"},{"syntax":"swift","code":["@Reducer ","struct Feature {","  struct State: Equatable {","    @Shared var count: Int","  }","  enum Action {","    case incrementButtonTapped","  }","  var body: some ReducerOf<Self> {","    Reduce { state, action in","      switch action {","      case .incrementButtonTapped:","        state.count += 1","        return .none","      }","    }","  }","}"],"type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"This feature can be tested in exactly the same way as when you are using non-shared state:"}]},{"code":["@Test","func increment() async {","  let store = TestStore(initialState: Feature.State(count: Shared(0))) {","    Feature()","  }","","  await store.send(.incrementButtonTapped) {","    $0.count = 1","  }","}"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"text":"This test passes because we have described how the state changes. But even better, if we mutate the","type":"text"},{"type":"text","text":" "},{"code":"count","type":"codeVoice"},{"text":" incorrectly:","type":"text"}]},{"type":"codeListing","syntax":"swift","code":["@Test","func increment() async {","  let store = TestStore(initialState: Feature.State(count: Shared(0))) {","    Feature()","  }","","  await store.send(.incrementButtonTapped) {","    $0.count = 2","  }","}"]},{"type":"paragraph","inlineContent":[{"text":"…we immediately get a test failure letting us know exactly what went wrong:","type":"text"}]},{"type":"codeListing","code":["❌ State was not expected to change, but a change occurred: …","","    − Feature.State(_count: 2)","    + Feature.State(_count: 1)","","(Expected: −, Actual: +)"],"syntax":null},{"type":"paragraph","inlineContent":[{"type":"text","text":"This works even though the "},{"type":"codeVoice","code":"@Shared"},{"type":"text","text":" count is a reference type. The "},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/TestStore"},{"text":" and ","type":"text"},{"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared","isActive":true},{"text":" ","type":"text"},{"type":"text","text":"type work in unison to snapshot the state before and after the action is sent, allowing us to still"},{"type":"text","text":" "},{"type":"text","text":"assert in an exhaustive manner."}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"However, exhaustively testing shared state is more complicated than testing non-shared state in"},{"type":"text","text":" "},{"type":"text","text":"features. Shared state can be captured in effects and mutated directly, without ever sending an"},{"text":" ","type":"text"},{"text":"action into system. This is in stark contrast to regular state, which can only ever be mutated when","type":"text"},{"type":"text","text":" "},{"type":"text","text":"sending an action."}]},{"inlineContent":[{"type":"text","text":"For example, it is possible to alter the "},{"code":"incrementButtonTapped","type":"codeVoice"},{"type":"text","text":" action so that it captures the"},{"text":" ","type":"text"},{"type":"text","text":"shared state in an effect, and then increments from the effect:"}],"type":"paragraph"},{"syntax":"swift","type":"codeListing","code":["case .incrementButtonTapped:","  return .run { [sharedCount = state.$count] _ in","    await sharedCount.withLock { $0 += 1 }","  }"]},{"inlineContent":[{"type":"text","text":"The only reason this is possible is because "},{"type":"codeVoice","code":"@Shared"},{"type":"text","text":" state is reference-like, and hence can"},{"type":"text","text":" "},{"text":"technically be mutated from anywhere.","type":"text"}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"text":"However, how does this affect testing? Since the ","type":"text"},{"code":"count","type":"codeVoice"},{"type":"text","text":" is no longer incremented directly in"},{"type":"text","text":" "},{"text":"the reducer we can drop the trailing closure from the test store assertion:","type":"text"}]},{"type":"codeListing","syntax":"swift","code":["@Test","func increment() async {","  let store = TestStore(initialState: SimpleFeature.State(count: Shared(0))) {","    SimpleFeature()","  }","  await store.send(.incrementButtonTapped)","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"This is technically correct, but we aren’t testing the behavior of the effect at all."}]},{"type":"paragraph","inlineContent":[{"text":"Luckily the ","type":"text"},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/TestStore","type":"reference","isActive":true},{"type":"text","text":" has our back. If you run this test you will immediately get a failure"},{"type":"text","text":" "},{"type":"text","text":"letting you know that the shared count was mutated but we did not assert on the changes:"}]},{"syntax":null,"code":["❌ Tracked changes to 'Shared<Int>@MyAppTests\/FeatureTests.swift:10' but failed to assert: …","","  − 0","  + 1","","(Before: −, After: +)","","Call 'Shared<Int>.assert' to exhaustively test these changes, or call 'skipChanges' to ignore them."],"type":"codeListing"},{"type":"paragraph","inlineContent":[{"type":"text","text":"In order to get this test passing we have to explicitly assert on the shared counter state at"},{"type":"text","text":" "},{"type":"text","text":"the end of the test, which we can do using the "},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/assert(_:fileID:file:line:column:)","isActive":true,"type":"reference"},{"text":" method:","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["@Test","func increment() async {","  let store = TestStore(initialState: SimpleFeature.State(count: Shared(0))) {","    SimpleFeature()","  }","  await store.send(.incrementButtonTapped)","  store.state.$count.assert {","    $0 = 1","  }","}"]},{"inlineContent":[{"type":"text","text":"Now the test passes."}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"type":"text","text":"So, even though the "},{"type":"codeVoice","code":"@Shared"},{"type":"text","text":" type opens our application up to a little bit more uncertainty due"},{"type":"text","text":" "},{"text":"to its reference semantics, it is still possible to get exhaustive test coverage on its changes.","type":"text"}]},{"text":"Testing when using persistence","level":4,"type":"heading","anchor":"Testing-when-using-persistence"},{"type":"paragraph","inlineContent":[{"text":"It is also possible to test when using one of the persistence strategies provided by the library,","type":"text"},{"type":"text","text":" "},{"type":"text","text":"which are "},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/appStorage(_:)-4l5b"},{"type":"text","text":" and"},{"text":" ","type":"text"},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/fileStorage(_:decoder:encoder:)"},{"text":". Typically persistence is difficult to test because the","type":"text"},{"type":"text","text":" "},{"type":"text","text":"persisted data bleeds over from test to test, making it difficult to exhaustively prove how each"},{"text":" ","type":"text"},{"type":"text","text":"test behaves in isolation."}]},{"inlineContent":[{"type":"text","text":"But the "},{"code":".appStorage","type":"codeVoice"},{"type":"text","text":" and "},{"type":"codeVoice","code":".fileStorage"},{"text":" strategies do extra work to make sure that happens. By","type":"text"},{"type":"text","text":" "},{"type":"text","text":"default the "},{"type":"codeVoice","code":".appStorage"},{"type":"text","text":" strategy uses a non-persisting user defaults so that changes are not"},{"type":"text","text":" "},{"text":"actually persisted across test runs. And the ","type":"text"},{"type":"codeVoice","code":".fileStorage"},{"text":" strategy uses a mock file system so that","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"changes to state are not actually persisted to the file system."}],"type":"paragraph"},{"inlineContent":[{"text":"This means that if we altered the ","type":"text"},{"code":"SimpleFeature","type":"codeVoice"},{"type":"text","text":" of the "},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState#Testing"},{"text":" section above to","type":"text"},{"type":"text","text":" "},{"text":"use app storage:","type":"text"}],"type":"paragraph"},{"type":"codeListing","syntax":"swift","code":["struct State: Equatable {","  @Shared(.appStorage(\"count\")) var count: Int","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"…then the test for this feature can be written in the same way as before and will still pass."}]},{"text":"Testing when using custom persistence strategies","anchor":"Testing-when-using-custom-persistence-strategies","type":"heading","level":4},{"inlineContent":[{"type":"text","text":"When creating your own custom persistence strategies you must careful to do so in a style that"},{"type":"text","text":" "},{"type":"text","text":"is amenable to testing. For example, the "},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/appStorage(_:)-4l5b","type":"reference","isActive":true},{"type":"text","text":" persistence"},{"type":"text","text":" "},{"type":"text","text":"strategy that comes with the library injects a "},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Dependencies\/DependencyValues\/defaultAppStorage"},{"text":" ","type":"text"},{"type":"text","text":"dependency so that one can inject a custom "},{"code":"UserDefaults","type":"codeVoice"},{"text":" in order to execute in a controlled","type":"text"},{"type":"text","text":" "},{"type":"text","text":"environment. By default "},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Dependencies\/DependencyValues\/defaultAppStorage"},{"text":" uses a non-persisting","type":"text"},{"type":"text","text":" "},{"type":"text","text":"user defaults, but you can also customize it to use any kind of defaults."}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Similarly the "},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/fileStorage(_:decoder:encoder:)","type":"reference","isActive":true},{"text":" persistence strategy uses an internal","type":"text"},{"type":"text","text":" "},{"type":"text","text":"dependency for changing how files are written to the disk and loaded from disk. In tests the"},{"type":"text","text":" "},{"type":"text","text":"dependency will forgo any interaction with the file system and instead write data to a "},{"type":"codeVoice","code":"[URL: Data]"},{"text":" ","type":"text"},{"text":"dictionary, and load data from that dictionary. That emulates how the file system works, but without","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"persisting any data to the global file system, which can bleed over into other tests."}]},{"type":"heading","anchor":"Overriding-shared-state-in-tests","level":4,"text":"Overriding shared state in tests"},{"inlineContent":[{"type":"text","text":"When testing features that use "},{"type":"codeVoice","code":"@Shared"},{"text":" with a persistence strategy you may want to set the initial","type":"text"},{"type":"text","text":" "},{"text":"value of that state for the test. Typically this can be done by declaring the shared state at","type":"text"},{"type":"text","text":" "},{"text":"the beginning of the test so that its default value can be specified:","type":"text"}],"type":"paragraph"},{"code":["@Test","func basics() {","  @Shared(.appStorage(\"count\")) var count = 42","","  \/\/ Shared state will be 42 for all features using it.","  let store = TestStore(…)","}"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"text":"However, if your test suite is a part of an app target, then the entry point of the app will execute","type":"text"},{"type":"text","text":" "},{"text":"and potentially cause an early access of ","type":"text"},{"code":"@Shared","type":"codeVoice"},{"type":"text","text":", thus capturing a different default value than"},{"text":" ","type":"text"},{"type":"text","text":"what is specified above. This quirk of tests in app targets is documented in"},{"text":" ","type":"text"},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Testing#Testing-gotchas"},{"type":"text","text":" of the "},{"type":"text","text":"doc:Testing"},{"text":" article, and a similar quirk exists for Xcode","type":"text"},{"type":"text","text":" "},{"text":"previews and is discussed below in ","type":"text"},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState#Gotchas-of-Shared","type":"reference","isActive":true},{"type":"text","text":"."}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"The most robust workaround to this issue is to simply not execute your app’s entry point when tests"},{"type":"text","text":" "},{"text":"are running, which we detail in ","type":"text"},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Testing#Testing-host-application"},{"text":". This makes it so that you","type":"text"},{"type":"text","text":" "},{"type":"text","text":"are not accidentally execute network requests, tracking analytics, etc. while running tests."}],"type":"paragraph"},{"inlineContent":[{"text":"You can also work around this issue by simply setting the shared state again after initializing","type":"text"},{"type":"text","text":" "},{"type":"text","text":"it:"}],"type":"paragraph"},{"code":["@Test","func basics() {","  @Shared(.appStorage(\"count\")) var count = 42","  count = 42  \/\/ NB: Set again to override any value set by the app target.","","  \/\/ Shared state will be 42 for all features using it.","  let store = TestStore(…)","}"],"type":"codeListing","syntax":"swift"},{"type":"heading","level":4,"text":"UI Testing","anchor":"UI-Testing"},{"type":"paragraph","inlineContent":[{"text":"When UI testing your app you must take extra care so that shared state is not persisted across","type":"text"},{"type":"text","text":" "},{"type":"text","text":"app runs because that can cause one test to bleed over into another test, making it difficult to"},{"text":" ","type":"text"},{"text":"write deterministic tests that always pass. To fix this, you can set an environment value from","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"your UI test target, and then if that value is present in the app target you can override the"},{"type":"text","text":" "},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Dependencies\/DependencyValues\/defaultAppStorage","isActive":true,"type":"reference"},{"type":"text","text":" and"},{"type":"text","text":" "},{"isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Dependencies\/DependencyValues\/defaultFileStorage","type":"reference"},{"type":"text","text":" dependencies so that they use in-memory"},{"text":" ","type":"text"},{"type":"text","text":"storage, i.e. they do not persist ever:"}]},{"type":"codeListing","syntax":"swift","code":["@main","struct EntryPoint: App {","  let store = Store(initialState: AppFeature.State()) {","    AppFeature()","  } withDependencies: {","    if ProcessInfo.processInfo.environment[\"UITesting\"] == \"true\" {","      $0.defaultAppStorage = UserDefaults(","        suiteName:\"\\(NSTemporaryDirectory())\\(UUID().uuidString)\"","      )!","      $0.defaultFileStorage = .inMemory","    }","  }","}"]},{"type":"heading","level":4,"anchor":"Testing-tips","text":"Testing tips"},{"inlineContent":[{"type":"text","text":"There is something you can do to make testing features with shared state more robust and catch"},{"type":"text","text":" "},{"type":"text","text":"more potential future problems when you refactor your code. Right now suppose you have two features"},{"text":" ","type":"text"},{"text":"using ","type":"text"},{"type":"codeVoice","code":"@Shared(.appStorage(\"count\"))"},{"text":":","type":"text"}],"type":"paragraph"},{"type":"codeListing","syntax":"swift","code":["@Reducer","struct Feature1 {","  struct State {","    @Shared(.appStorage(\"count\")) var count = 0","  }","  \/\/ ...","}","","@Reducer","struct Feature2 {","  struct State {","    @Shared(.appStorage(\"count\")) var count = 0","  }","  \/\/ ...","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"And suppose you wrote a test that proves one of these counts is incremented when a button is tapped:"}]},{"type":"codeListing","syntax":"swift","code":["await store.send(.feature1(.buttonTapped)) {","  $0.feature1.count = 1","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"Because both features are using "},{"type":"codeVoice","code":"@Shared"},{"text":" you can be sure that both counts are kept in sync, and","type":"text"},{"type":"text","text":" "},{"text":"so you do not need to assert on ","type":"text"},{"code":"feature2.count","type":"codeVoice"},{"text":".","type":"text"}]},{"type":"paragraph","inlineContent":[{"type":"text","text":"However, if someday during a long, complex refactor you accidentally removed "},{"type":"codeVoice","code":"@Shared"},{"type":"text","text":" from"},{"text":" ","type":"text"},{"type":"text","text":"the second feature:"}]},{"syntax":"swift","code":["@Reducer","struct Feature2 {","  struct State {","    var count = 0","  }","  \/\/ ...","}"],"type":"codeListing"},{"inlineContent":[{"type":"text","text":"…then all of your code would continue compiling, and the test would still pass, but you may have"},{"text":" ","type":"text"},{"type":"text","text":"introduced a bug by not having these two pieces of state in sync anymore."}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"text":"You could also fix this by forcing yourself to assert on all shared state in your features, even","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"though technically it’s not necessary:"}]},{"type":"codeListing","syntax":"swift","code":["await store.send(.feature1(.buttonTapped)) {","  $0.feature1.count = 1","  $0.feature2.count = 1","}"]},{"inlineContent":[{"type":"text","text":"If you are worried about these kinds of bugs you can make your tests more robust by not asserting"},{"type":"text","text":" "},{"type":"text","text":"on the shared state in the argument handed to the trailing closure of "},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/TestStore"},{"text":"’s ","type":"text"},{"type":"codeVoice","code":"send"},{"type":"text","text":", and"},{"type":"text","text":" "},{"type":"text","text":"instead capture a reference to the shared state in the test and mutate it in the trailing"},{"text":" ","type":"text"},{"type":"text","text":"closure:"}],"type":"paragraph"},{"code":["@Test","func increment() async {","  @Shared(.appStorage(\"count\")) var count = 0","  let store = TestStore(initialState: ParentFeature.State()) {","    ParentFeature()","  }","","  await store.send(.feature1(.buttonTapped)) {","    \/\/ Mutate $0 to expected value.","    count = 1","  }","}"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"type":"text","text":"This will fail if you accidentally remove a "},{"type":"codeVoice","code":"@Shared"},{"type":"text","text":" from one of your features."}],"type":"paragraph"},{"inlineContent":[{"text":"Further, you can enforce this pattern in your codebase by making all ","type":"text"},{"type":"codeVoice","code":"@Shared"},{"text":" properties","type":"text"},{"type":"text","text":" "},{"code":"fileprivate","type":"codeVoice"},{"text":" so that they can never be mutated outside their file scope:","type":"text"}],"type":"paragraph"},{"type":"codeListing","syntax":"swift","code":["struct State {","  @Shared(.appStorage(\"count\")) fileprivate var count = 0","}"]},{"text":"Read-only shared state","level":2,"type":"heading","anchor":"Read-only-shared-state"},{"type":"paragraph","inlineContent":[{"text":"The ","type":"text"},{"overridingTitleInlineContent":[{"type":"codeVoice","code":"@Shared"}],"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared","overridingTitle":"@Shared","isActive":true},{"text":" property wrapper described above gives you access to a piece of shared","type":"text"},{"type":"text","text":" "},{"type":"text","text":"state that is both readable and writable. That is by far the most common use case when it comes to"},{"type":"text","text":" "},{"type":"text","text":"shared state, but there are times when one wants to express access to shared state for which you"},{"text":" ","type":"text"},{"text":"are not allowed to write to it, or possibly it doesn’t even make sense to write to it.","type":"text"}]},{"inlineContent":[{"type":"text","text":"For those times there is the "},{"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharedReader","overridingTitle":"@SharedReader","isActive":true,"overridingTitleInlineContent":[{"code":"@SharedReader","type":"codeVoice"}]},{"type":"text","text":" property wrapper. It represents"},{"type":"text","text":" "},{"type":"text","text":"a reference to some piece of state shared with multiple parts of the application, but you are not"},{"type":"text","text":" "},{"type":"text","text":"allowed to write to it. Every persistence strategy discussed above works with "},{"isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharedReader","type":"reference"},{"text":",","type":"text"},{"type":"text","text":" "},{"type":"text","text":"however if you try to mutate the state you will get a compiler error:"}],"type":"paragraph"},{"code":["@SharedReader(.appStorage(\"isOn\")) var isOn = false","isOn = true  \/\/ 🛑"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"type":"text","text":"It is also possible to make custom persistence strategies that only have the notion of loading and"},{"text":" ","type":"text"},{"type":"text","text":"subscribing, but cannot write. To do this you will conform only to the "},{"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey","isActive":true},{"text":" ","type":"text"},{"type":"text","text":"protocol instead of the full "},{"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceKey","isActive":true},{"type":"text","text":" protocol."}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"For example, you could create a "},{"code":".remoteConfig","type":"codeVoice"},{"text":" strategy that loads (and subscribes to) a remote","type":"text"},{"text":" ","type":"text"},{"text":"configuration file held on your server so that it is kept automatically in sync:","type":"text"}],"type":"paragraph"},{"type":"codeListing","syntax":"swift","code":["@SharedReader(.remoteConfig) var remoteConfig"]},{"level":2,"anchor":"Type-safe-keys","text":"Type-safe keys","type":"heading"},{"type":"paragraph","inlineContent":[{"text":"Due to the nature of persisting data to external systems, you lose some type safety when shuffling","type":"text"},{"type":"text","text":" "},{"type":"text","text":"data from your app to the persistence storage and back. For example, if you are using the"},{"text":" ","type":"text"},{"isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/fileStorage(_:decoder:encoder:)","type":"reference"},{"text":" strategy to save an array of users to disk you might do so","type":"text"},{"type":"text","text":" "},{"type":"text","text":"like this:"}]},{"code":["extension URL {","  static let users = URL(\/* ... *\/))","}","","@Shared(.fileStorage(.users)) var users: [User] = []"],"type":"codeListing","syntax":"swift"},{"type":"paragraph","inlineContent":[{"type":"text","text":"And say you have used this file storage users in multiple places throughout your application."}]},{"inlineContent":[{"type":"text","text":"But then, someday in the future you may decide to refactor this data to be an identified array"},{"text":" ","type":"text"},{"type":"text","text":"instead of a plain array:"}],"type":"paragraph"},{"syntax":"swift","type":"codeListing","code":["\/\/ Somewhere else in the application","@Shared(.fileStorage(.users)) var users: IdentifiedArrayOf<User> = []"]},{"inlineContent":[{"type":"text","text":"But if you forget to convert "},{"inlineContent":[{"type":"text","text":"all"}],"type":"emphasis"},{"type":"text","text":" shared user arrays to the new identified array your application"},{"text":" ","type":"text"},{"type":"text","text":"will still compile, but it will be broken. The two types of storage will not share state."}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"To add some type-safety and reusability to this process you can extend the "},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey","isActive":true,"type":"reference"},{"type":"text","text":" "},{"text":"protocol to add a static variable for describing the details of your persistence:","type":"text"}],"type":"paragraph"},{"type":"codeListing","code":["extension PersistenceReaderKey where Self == FileStorageKey<IdentifiedArrayOf<User>> {","  static var users: Self {","    fileStorage(.users)","  }","}"],"syntax":"swift"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Then when using "},{"overridingTitle":"@Shared","overridingTitleInlineContent":[{"type":"codeVoice","code":"@Shared"}],"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared"},{"text":" you can specify this key directly without ","type":"text"},{"type":"codeVoice","code":".fileStorage"},{"type":"text","text":":"}]},{"type":"codeListing","syntax":"swift","code":["@Shared(.users) var users: IdentifiedArrayOf<User> = []"]},{"inlineContent":[{"text":"And now that the type is baked into the key you cannot accidentally use the wrong type because you","type":"text"},{"text":" ","type":"text"},{"text":"will get an immediate compiler error:","type":"text"}],"type":"paragraph"},{"syntax":"swift","type":"codeListing","code":["@Shared(.users) var users = [User]()"]},{"type":"aside","name":"🛑 Error","style":"note","content":[{"type":"paragraph","inlineContent":[{"text":"Cannot convert value of type ‘[User]’ to expected argument type ‘IdentifiedArrayOf","type":"text"},{"type":"text","text":"’"}]}]},{"type":"paragraph","inlineContent":[{"text":"This technique works for all types of persistence strategies. For example, a type-safe ","type":"text"},{"type":"codeVoice","code":".inMemory"},{"text":" ","type":"text"},{"text":"key can be constructed like so:","type":"text"}]},{"type":"codeListing","syntax":"swift","code":["extension PersistenceReaderKey where Self == InMemoryKey<IdentifiedArrayOf<User>> {","  static var users: Self {","    inMemory(\"users\")","  }","}"]},{"inlineContent":[{"type":"text","text":"And a type-safe "},{"code":".appStorage","type":"codeVoice"},{"text":" key can be constructed like so:","type":"text"}],"type":"paragraph"},{"code":["extension PersistenceReaderKey where Self == AppStorageKey<Int> {","  static var count: Self {","    appStorage(\"count\")","  }","}"],"type":"codeListing","syntax":"swift"},{"inlineContent":[{"text":"And this technique also works on ","type":"text"},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState#Custom-persistence","isActive":true,"overridingTitle":"custom persistence","type":"reference","overridingTitleInlineContent":[{"text":"custom persistence","type":"text"}]},{"text":" ","type":"text"},{"type":"text","text":"strategies."}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"text":"Further, you can use the ","type":"text"},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceKeyDefault"},{"type":"text","text":" type to also provide a default that is used"},{"type":"text","text":" "},{"text":"with the persistence strategy. For example, to use a default value of ","type":"text"},{"type":"codeVoice","code":"[]"},{"text":" with the ","type":"text"},{"type":"codeVoice","code":".users"},{"type":"text","text":" "},{"type":"text","text":"persistence strategy described above, we can do the following:"}]},{"type":"codeListing","syntax":"swift","code":["extension PersistenceReaderKey ","where Self == PersistenceKeyDefault<FileStorageKey<IdentifiedArrayOf<User>>>","{","  static var users: Self {","    PersistenceKeyDefault(.fileStorage(.users), [])","  }","}"]},{"type":"paragraph","inlineContent":[{"text":"And now anytime you reference the shared users state you can leave off the default value, and","type":"text"},{"type":"text","text":" "},{"type":"text","text":"you can even leave off the type annotation:"}]},{"syntax":"swift","type":"codeListing","code":["@Shared(.users) var users"]},{"anchor":"Shared-state-in-pre-observation-apps","level":2,"text":"Shared state in pre-observation apps","type":"heading"},{"type":"paragraph","inlineContent":[{"text":"It is possible to use ","type":"text"},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared","type":"reference","overridingTitle":"@Shared","overridingTitleInlineContent":[{"code":"@Shared","type":"codeVoice"}],"isActive":true},{"text":" in features that have not yet been updated with","type":"text"},{"type":"text","text":" "},{"text":"the observation tools released in 1.7, such as the ","type":"text"},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/ObservableState()","isActive":true,"type":"reference"},{"type":"text","text":" macro. In the reducer"},{"type":"text","text":" "},{"type":"text","text":"you can use "},{"type":"codeVoice","code":"@Shared"},{"text":" regardless of your use of the observation tools.","type":"text"}]},{"type":"paragraph","inlineContent":[{"text":"However, if you are deploying to iOS 16 or earlier, then you must use ","type":"text"},{"type":"codeVoice","code":"WithPerceptionTracking"},{"type":"text","text":" "},{"type":"text","text":"in your views if you are accessing shared state. For example, the following view:"}]},{"type":"codeListing","syntax":"swift","code":["struct FeatureView: View {","  let store: StoreOf<Feature>","","  var body: some View {","    Form {","      Text(store.sharedCount.description)","    }","  }","}"]},{"type":"paragraph","inlineContent":[{"text":"…will not update properly when ","type":"text"},{"type":"codeVoice","code":"sharedCount"},{"text":" changes. This view will even generate a runtime warning","type":"text"},{"type":"text","text":" "},{"text":"letting you know something is wrong:","type":"text"}]},{"name":"🟣 Runtime Warning","style":"note","type":"aside","content":[{"inlineContent":[{"type":"text","text":"Perceptible state was accessed but is not being tracked. Track changes to"},{"type":"text","text":" "},{"type":"text","text":"state by wrapping your view in a ‘WithPerceptionTracking’ view."}],"type":"paragraph"}]},{"inlineContent":[{"type":"text","text":"The fix is to wrap the body of the view in "},{"type":"codeVoice","code":"WithPerceptionTracking"},{"type":"text","text":":"}],"type":"paragraph"},{"type":"codeListing","syntax":"swift","code":["struct FeatureView: View {","  let store: StoreOf<Feature>","","  var body: some View {","    WithPerceptionTracking {","      Form {","        Text(store.sharedCount.description)","      }","    }","  }","}"]},{"level":2,"text":"Concurrent mutations to shared state","anchor":"Concurrent-mutations-to-shared-state","type":"heading"},{"inlineContent":[{"type":"text","text":"While the "},{"type":"reference","overridingTitle":"@Shared","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared","overridingTitleInlineContent":[{"type":"codeVoice","code":"@Shared"}],"isActive":true},{"type":"text","text":" property wrapper makes it possible to treat shared state"},{"text":" ","type":"text"},{"inlineContent":[{"text":"mostly","type":"text"}],"type":"emphasis"},{"type":"text","text":" like regular state, you do have to perform some extra steps to mutate shared state from"},{"type":"text","text":" "},{"text":"an asynchronous context. This is because shared state is technically a reference deep down, even","type":"text"},{"text":" ","type":"text"},{"type":"text","text":"though we take extra steps to make it appear value-like. And this means it’s possible to mutate the"},{"text":" ","type":"text"},{"type":"text","text":"same piece of shared state from multiple threads, and hence race conditions are possible."}],"type":"paragraph"},{"inlineContent":[{"text":"To mutate a piece of shared state in an isolated fashion, use the ","type":"text"},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/withLock(_:)"},{"type":"text","text":" method"},{"text":" ","type":"text"},{"type":"text","text":"defined on the "},{"type":"codeVoice","code":"@Shared"},{"text":" projected value:","type":"text"}],"type":"paragraph"},{"type":"codeListing","code":["await state.$count.withLock { $0 += 1 }"],"syntax":"swift"},{"type":"paragraph","inlineContent":[{"text":"That locks the entire unit of work of reading the current count, incrementing it, and storing it","type":"text"},{"type":"text","text":" "},{"type":"text","text":"back in the reference."}]},{"type":"paragraph","inlineContent":[{"text":"Technically it is still possible to write code that has race conditions, such as this silly example:","type":"text"}]},{"type":"codeListing","syntax":"swift","code":["let currentCount = state.count","await state.$count.withLock { $0 = currentCount + 1 }"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"But there is no way to 100% prevent race conditions in code. Even actors are susceptible to"},{"type":"text","text":" "},{"text":"problems due to re-entrancy. To avoid problems like the above we recommend wrapping as many","type":"text"},{"text":" ","type":"text"},{"text":"mutations of the shared state as possible in a single ","type":"text"},{"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/withLock(_:)","isActive":true},{"type":"text","text":". That will make"},{"type":"text","text":" "},{"text":"sure that the full unit of work is guarded by a lock.","type":"text"}]},{"style":"note","content":[{"inlineContent":[{"text":"You may encounter a deprecation warning when simply ","type":"text"},{"inlineContent":[{"text":"accessing","type":"text"}],"type":"emphasis"},{"type":"text","text":" shared state from an"},{"text":" ","type":"text"},{"text":"asynchronous context when you chain into a subscript:","type":"text"}],"type":"paragraph"},{"code":["return .run { _ in","  @Shared(.posts) var posts","  let post = posts[id: id]  \/\/ ⚠️ Setter is unavailable from asynchronous contexts","  \/\/ ...","}"],"syntax":"swift","type":"codeListing"},{"type":"paragraph","inlineContent":[{"text":"This is a ","type":"text"},{"identifier":"https:\/\/github.com\/apple\/swift\/issues\/74203","isActive":true,"type":"reference"},{"text":" in the Swift compiler, but","type":"text"},{"type":"text","text":" "},{"type":"text","text":"can be worked around using "},{"isActive":true,"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/withLock(_:)"},{"text":" to access the underlying value instead:","type":"text"}]},{"syntax":"swift","code":["return .run { _ in","  @Shared(.posts) var posts","  let post = await $posts.withLock { $0[id: id] }","  \/\/ ...","}"],"type":"codeListing"}],"name":"Note","type":"aside"},{"level":2,"anchor":"Gotchas-of-Shared","text":"Gotchas of @Shared","type":"heading"},{"inlineContent":[{"type":"text","text":"There are a few gotchas to be aware of when using shared state in the Composable Architecture."}],"type":"paragraph"},{"text":"Hashability","anchor":"Hashability","type":"heading","level":4},{"inlineContent":[{"text":"Because the ","type":"text"},{"code":"@Shared","type":"codeVoice"},{"text":" type is equatable based on its wrapped value, and because the value is held","type":"text"},{"type":"text","text":" "},{"text":"in a reference and can change over time, it cannot be hashable. This also means that types","type":"text"},{"type":"text","text":" "},{"type":"text","text":"containing "},{"type":"codeVoice","code":"@Shared"},{"type":"text","text":" properties should not compute their hashes from shared values."}],"type":"paragraph"},{"text":"Codability","anchor":"Codability","type":"heading","level":4},{"type":"paragraph","inlineContent":[{"type":"text","text":"The "},{"code":"@Shared","type":"codeVoice"},{"type":"text","text":" type is not conditionally encodable or decodable because the source of truth of the"},{"text":" ","type":"text"},{"text":"wrapped value is rarely local: it might be derived from some other shared value, or it might rely on","type":"text"},{"type":"text","text":" "},{"type":"text","text":"loading the value from a backing persistence strategy."}]},{"inlineContent":[{"type":"text","text":"When introducing shared state to a data type that is encodable or decodable, you must provide your"},{"type":"text","text":" "},{"type":"text","text":"own implementations of "},{"code":"encode(to:)","type":"codeVoice"},{"type":"text","text":" and "},{"code":"init(from:)","type":"codeVoice"},{"text":" that do the appropriate thing.","type":"text"}],"type":"paragraph"},{"type":"paragraph","inlineContent":[{"type":"text","text":"For example, if the data type is sharing state with a persistence strategy, you can decode by"},{"type":"text","text":" "},{"text":"delegating to the memberwise initializer that implicitly loads the shared value from the property","type":"text"},{"type":"text","text":" "},{"type":"text","text":"wrapper’s persistence strategy, or you can explicitly initialize a shared value via"},{"type":"text","text":" "},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/init(wrappedValue:_:fileID:line:)-9kfmy"},{"type":"text","text":". And for encoding you can often skip encoding"},{"type":"text","text":" "},{"text":"the shared value:","type":"text"}]},{"type":"codeListing","syntax":"swift","code":["struct AppState {","  @Shared(.appStorage(\"launchCount\")) var launchCount = 0","  var todos: [String] = []","}","","extension AppState: Codable {","  enum CodingKeys: String, CodingKey { case todos }","","  init(from decoder: any Decoder) throws {","    let container = try decoder.container(keyedBy: CodingKeys.self)","","    \/\/ Use the property wrapper default via the memberwise initializer:","    try self.init(","      todos: container.decode([String].self, forKey: .todos)","    )","","    \/\/ Or initialize the shared storage manually:","    self._launchCount = Shared(wrappedValue: 0, .appStorage(\"launchCount\"))","    self.todos = try container.decode([String].self, forKey: .todos)","  }","","  func encode(to encoder: any Encoder) throws {","    var container = encoder.container(keyedBy: CodingKeys.self)","    try container.encode(self.todos, forKey: .todos)","    \/\/ Skip encoding the launch count.","  }","}"]},{"type":"heading","anchor":"Previews","text":"Previews","level":4},{"inlineContent":[{"text":"When a preview is run in an app target, the entry point is also created. This means if your entry","type":"text"},{"text":" ","type":"text"},{"text":"point looks something like this:","type":"text"}],"type":"paragraph"},{"type":"codeListing","syntax":"swift","code":["@main","struct MainApp: App {","  let store = Store(…)","","  var body: some Scene {","    …","  }","}"]},{"type":"paragraph","inlineContent":[{"type":"text","text":"…then a store will be created each time you run your preview. This can be problematic with "},{"type":"codeVoice","code":"@Shared"},{"type":"text","text":" "},{"text":"and persistence strategies because the first access of a ","type":"text"},{"code":"@Shared","type":"codeVoice"},{"text":" property will use the default","type":"text"},{"type":"text","text":" "},{"text":"value provided, and that will cause ","type":"text"},{"code":"@Shared","type":"codeVoice"},{"text":"’s created later to ignore the default. That will mean","type":"text"},{"type":"text","text":" "},{"type":"text","text":"you cannot override shared state in previews."}]},{"inlineContent":[{"type":"text","text":"The fix is to delay creation of the store until the entry point’s "},{"code":"body","type":"codeVoice"},{"type":"text","text":" is executed. Further, it"},{"type":"text","text":" "},{"type":"text","text":"can be a good idea to also not run the "},{"type":"codeVoice","code":"body"},{"type":"text","text":" when in tests because that can also interfere with"},{"text":" ","type":"text"},{"type":"text","text":"tests (as documented in "},{"type":"reference","isActive":true,"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Testing#Testing-gotchas"},{"text":"). Here is one way this can be accomplished:","type":"text"}],"type":"paragraph"},{"code":["import ComposableArchitecture","import SwiftUI","","@main","struct MainApp: App {","  @MainActor","  static let store = Store(…)","","  var body: some Scene {","    WindowGroup {","      if isTesting {","        \/\/ NB: Don't run application in tests to avoid interference ","        \/\/     between the app and the test.","        EmptyView()","      } else {","        AppView(store: Self.store)","      }","    }","  }","}"],"type":"codeListing","syntax":"swift"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Alternatively you can take an extra step to override shared state in your previews:"}]},{"type":"codeListing","syntax":"swift","code":["#Preview {","  @Shared(.appStorage(\"isOn\")) var isOn = true","  isOn = true","}"]},{"inlineContent":[{"text":"The second assignment of ","type":"text"},{"code":"isOn","type":"codeVoice"},{"type":"text","text":" will guarantee that it holds a value of "},{"type":"codeVoice","code":"true"},{"type":"text","text":"."}],"type":"paragraph"}]}],"metadata":{"role":"collectionGroup","modules":[{"name":"ComposableArchitecture"}],"title":"Sharing state","roleHeading":"API Collection"},"identifier":{"interfaceLanguage":"swift","url":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState"},"references":{"doc://ComposableArchitecture/documentation/ComposableArchitecture/SharingState#File-storage":{"title":"File storage","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState#File-storage","abstract":[],"url":"\/documentation\/composablearchitecture\/sharingstate#File-storage","kind":"section","type":"topic"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/PersistenceReaderKey/fileStorage(_:decoder:encoder:)":{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/fileStorage(_:decoder:encoder:)","title":"fileStorage(_:decoder:encoder:)","url":"\/documentation\/composablearchitecture\/persistencereaderkey\/filestorage(_:decoder:encoder:)","role":"symbol","type":"topic","kind":"symbol","fragments":[{"kind":"keyword","text":"static"},{"text":" ","kind":"text"},{"kind":"keyword","text":"func"},{"kind":"text","text":" "},{"text":"fileStorage","kind":"identifier"},{"text":"<","kind":"text"},{"kind":"genericParameter","text":"Value"},{"kind":"text","text":">("},{"text":"URL","kind":"typeIdentifier","preciseIdentifier":"s:10Foundation3URLV"},{"text":", ","kind":"text"},{"kind":"externalParam","text":"decoder"},{"kind":"text","text":": "},{"text":"JSONDecoder","kind":"typeIdentifier","preciseIdentifier":"s:10Foundation11JSONDecoderC"},{"kind":"text","text":", "},{"text":"encoder","kind":"externalParam"},{"text":": ","kind":"text"},{"text":"JSONEncoder","kind":"typeIdentifier","preciseIdentifier":"s:10Foundation11JSONEncoderC"},{"kind":"text","text":") -> "},{"kind":"typeIdentifier","text":"Self"}],"abstract":[{"text":"Creates a persistence key that can read and write to a ","type":"text"},{"code":"Codable","type":"codeVoice"},{"type":"text","text":" value in the file system."}]},"#Testing-when-using-persistence":{"title":"Testing when using persistence","identifier":"#Testing-when-using-persistence","titleInlineContent":[{"type":"text","text":"Testing when using persistence"}],"url":"#Testing-when-using-persistence","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Shared":{"title":"Shared","abstract":[{"type":"text","text":"A property wrapper type that shares a value with multiple parts of an application."}],"role":"symbol","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared","type":"topic","navigatorTitle":[{"text":"Shared","kind":"identifier"}],"fragments":[{"text":"struct","kind":"keyword"},{"text":" ","kind":"text"},{"text":"Shared","kind":"identifier"}],"kind":"symbol","url":"\/documentation\/composablearchitecture\/shared"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Reducer/State":{"url":"\/documentation\/composablearchitecture\/reducer\/state","role":"symbol","kind":"symbol","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Reducer\/State","fragments":[{"text":"associatedtype","kind":"keyword"},{"text":" ","kind":"text"},{"kind":"identifier","text":"State"}],"title":"State","type":"topic","abstract":[{"text":"A type that holds the current state of the reducer.","type":"text"}],"required":true},"#File-storage":{"title":"File storage","identifier":"#File-storage","titleInlineContent":[{"type":"text","text":"File storage"}],"url":"#File-storage","type":"link"},"#Type-safe-keys":{"title":"Type-safe keys","identifier":"#Type-safe-keys","titleInlineContent":[{"type":"text","text":"Type-safe keys"}],"url":"#Type-safe-keys","type":"link"},"#Testing":{"title":"Testing","identifier":"#Testing","titleInlineContent":[{"type":"text","text":"Testing"}],"url":"#Testing","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Shared/publisher":{"type":"topic","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/publisher","title":"publisher","abstract":[{"type":"text","text":"Returns a publisher that emits events when the underlying value changes."}],"fragments":[{"kind":"keyword","text":"var"},{"kind":"text","text":" "},{"kind":"identifier","text":"publisher"},{"kind":"text","text":": "},{"text":"AnyPublisher","kind":"typeIdentifier","preciseIdentifier":"s:7Combine12AnyPublisherV"},{"text":"<","kind":"text"},{"kind":"typeIdentifier","text":"Value"},{"kind":"text","text":", "},{"text":"Never","kind":"typeIdentifier","preciseIdentifier":"s:s5NeverO"},{"text":">","kind":"text"}],"kind":"symbol","url":"\/documentation\/composablearchitecture\/shared\/publisher","role":"symbol"},"#Testing-when-using-custom-persistence-strategies":{"title":"Testing when using custom persistence strategies","identifier":"#Testing-when-using-custom-persistence-strategies","titleInlineContent":[{"type":"text","text":"Testing when using custom persistence strategies"}],"url":"#Testing-when-using-custom-persistence-strategies","type":"link"},"#Shared-state-in-pre-observation-apps":{"title":"Shared state in pre-observation apps","identifier":"#Shared-state-in-pre-observation-apps","titleInlineContent":[{"type":"text","text":"Shared state in pre-observation apps"}],"url":"#Shared-state-in-pre-observation-apps","type":"link"},"#Concurrent-mutations-to-shared-state":{"title":"Concurrent mutations to shared state","identifier":"#Concurrent-mutations-to-shared-state","titleInlineContent":[{"type":"text","text":"Concurrent mutations to shared state"}],"url":"#Concurrent-mutations-to-shared-state","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/PersistenceKeyDefault":{"kind":"symbol","type":"topic","abstract":[{"type":"text","text":"A persistence key that provides a default value to an existing persistence key."}],"role":"symbol","navigatorTitle":[{"kind":"identifier","text":"PersistenceKeyDefault"}],"title":"PersistenceKeyDefault","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceKeyDefault","fragments":[{"text":"struct","kind":"keyword"},{"kind":"text","text":" "},{"kind":"identifier","text":"PersistenceKeyDefault"}],"url":"\/documentation\/composablearchitecture\/persistencekeydefault"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/PersistenceReaderKey/appStorage(_:)-4l5b":{"fragments":[{"text":"static","kind":"keyword"},{"text":" ","kind":"text"},{"text":"func","kind":"keyword"},{"kind":"text","text":" "},{"text":"appStorage","kind":"identifier"},{"text":"(","kind":"text"},{"text":"String","kind":"typeIdentifier","preciseIdentifier":"s:SS"},{"text":") -> ","kind":"text"},{"kind":"typeIdentifier","text":"Self"}],"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/appStorage(_:)-4l5b","role":"symbol","type":"topic","title":"appStorage(_:)","abstract":[{"type":"text","text":"Creates a persistence key that can read and write to a boolean user default."}],"url":"\/documentation\/composablearchitecture\/persistencereaderkey\/appstorage(_:)-4l5b","kind":"symbol"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/InMemoryKey":{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/InMemoryKey","title":"InMemoryKey","url":"\/documentation\/composablearchitecture\/inmemorykey","role":"symbol","type":"topic","kind":"symbol","fragments":[{"kind":"keyword","text":"struct"},{"kind":"text","text":" "},{"text":"InMemoryKey","kind":"identifier"}],"abstract":[{"text":"A type defining an in-memory persistence strategy","type":"text"}],"navigatorTitle":[{"kind":"identifier","text":"InMemoryKey"}]},"#UI-Testing":{"title":"UI Testing","identifier":"#UI-Testing","titleInlineContent":[{"type":"text","text":"UI Testing"}],"url":"#UI-Testing","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Testing#Testing-host-application":{"title":"Testing host application","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Testing#Testing-host-application","abstract":[],"url":"\/documentation\/composablearchitecture\/testing#Testing-host-application","kind":"section","type":"topic"},"#Initialization-rules":{"title":"Initialization rules","identifier":"#Initialization-rules","titleInlineContent":[{"type":"text","text":"Initialization rules"}],"url":"#Initialization-rules","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Dependencies/DependencyValues/defaultAppStorage":{"url":"\/documentation\/composablearchitecture\/dependencies\/dependencyvalues\/defaultappstorage","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Dependencies\/DependencyValues\/defaultAppStorage","kind":"symbol","abstract":[],"title":"defaultAppStorage","type":"topic","fragments":[{"text":"var","kind":"keyword"},{"text":" ","kind":"text"},{"kind":"identifier","text":"defaultAppStorage"},{"text":": ","kind":"text"},{"kind":"typeIdentifier","preciseIdentifier":"c:objc(cs)NSUserDefaults","text":"UserDefaults"}],"role":"symbol"},"#In-memory":{"title":"In-memory","identifier":"#In-memory","titleInlineContent":[{"type":"text","text":"In-memory"}],"url":"#In-memory","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/AppStorageKey":{"kind":"symbol","navigatorTitle":[{"kind":"identifier","text":"AppStorageKey"}],"abstract":[{"text":"A type defining a user defaults persistence strategy.","type":"text"}],"type":"topic","fragments":[{"text":"struct","kind":"keyword"},{"kind":"text","text":" "},{"kind":"identifier","text":"AppStorageKey"}],"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/AppStorageKey","url":"\/documentation\/composablearchitecture\/appstoragekey","title":"AppStorageKey","role":"symbol"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/FileStorageKey":{"navigatorTitle":[{"kind":"identifier","text":"FileStorageKey"}],"url":"\/documentation\/composablearchitecture\/filestoragekey","abstract":[{"type":"text","text":"A type defining a file persistence strategy"}],"fragments":[{"text":"class","kind":"keyword"},{"text":" ","kind":"text"},{"kind":"identifier","text":"FileStorageKey"}],"kind":"symbol","title":"FileStorageKey","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/FileStorageKey","role":"symbol","type":"topic"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Shared/withLock(_:)":{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/withLock(_:)","url":"\/documentation\/composablearchitecture\/shared\/withlock(_:)","title":"withLock(_:)","role":"symbol","abstract":[{"text":"Perform an operation on shared state with isolated access to the underlying value.","type":"text"}],"fragments":[{"text":"func","kind":"keyword"},{"kind":"text","text":" "},{"text":"withLock","kind":"identifier"},{"text":"<","kind":"text"},{"kind":"genericParameter","text":"R"},{"text":">((","kind":"text"},{"text":"inout","kind":"keyword"},{"kind":"text","text":" "},{"text":"Value","kind":"typeIdentifier"},{"text":") ","kind":"text"},{"kind":"keyword","text":"throws"},{"kind":"text","text":" -> "},{"kind":"typeIdentifier","text":"R"},{"kind":"text","text":") "},{"kind":"keyword","text":"rethrows"},{"kind":"text","text":" -> "},{"kind":"typeIdentifier","text":"R"}],"type":"topic","kind":"symbol"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Navigation":{"type":"topic","role":"collectionGroup","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Navigation","title":"Navigation","kind":"article","url":"\/documentation\/composablearchitecture\/navigation","abstract":[{"text":"Learn how to use the navigation tools in the library, including how to best model your domains, how","type":"text"},{"type":"text","text":" "},{"text":"to integrate features in the reducer and view layers, and how to write tests.","type":"text"}]},"doc://ComposableArchitecture/documentation/ComposableArchitecture/GettingStarted":{"abstract":[{"text":"Learn how to integrate the Composable Architecture into your project and write your first","type":"text"},{"type":"text","text":" "},{"text":"application.","type":"text"}],"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/GettingStarted","title":"Getting started","role":"article","kind":"article","url":"\/documentation\/composablearchitecture\/gettingstarted","type":"topic"},"#Persisted-shared-state":{"title":"Persisted shared state","identifier":"#Persisted-shared-state","titleInlineContent":[{"type":"text","text":"Persisted shared state"}],"url":"#Persisted-shared-state","type":"link"},"#Deriving-shared-state":{"title":"Deriving shared state","identifier":"#Deriving-shared-state","titleInlineContent":[{"type":"text","text":"Deriving shared state"}],"url":"#Deriving-shared-state","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/SharingState#Custom-persistence":{"type":"topic","kind":"section","title":"Custom persistence","url":"\/documentation\/composablearchitecture\/sharingstate#Custom-persistence","abstract":[],"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState#Custom-persistence"},"#Source-of-truth":{"title":"“Source of truth”","identifier":"#Source-of-truth","titleInlineContent":[{"type":"text","text":"“Source of truth”"}],"url":"#Source-of-truth","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Shared/assert(_:fileID:file:line:column:)":{"url":"\/documentation\/composablearchitecture\/shared\/assert(_:fileid:file:line:column:)","fragments":[{"text":"func","kind":"keyword"},{"kind":"text","text":" "},{"text":"assert","kind":"identifier"},{"kind":"text","text":"(("},{"text":"inout","kind":"keyword"},{"kind":"text","text":" "},{"kind":"typeIdentifier","text":"Value"},{"text":") ","kind":"text"},{"kind":"keyword","text":"throws"},{"text":" -> ","kind":"text"},{"preciseIdentifier":"s:s4Voida","text":"Void","kind":"typeIdentifier"},{"text":", ","kind":"text"},{"kind":"externalParam","text":"fileID"},{"text":": ","kind":"text"},{"text":"StaticString","kind":"typeIdentifier","preciseIdentifier":"s:s12StaticStringV"},{"text":", ","kind":"text"},{"text":"file","kind":"externalParam"},{"text":": ","kind":"text"},{"text":"StaticString","kind":"typeIdentifier","preciseIdentifier":"s:s12StaticStringV"},{"kind":"text","text":", "},{"kind":"externalParam","text":"line"},{"kind":"text","text":": "},{"text":"UInt","preciseIdentifier":"s:Su","kind":"typeIdentifier"},{"text":", ","kind":"text"},{"text":"column","kind":"externalParam"},{"text":": ","kind":"text"},{"kind":"typeIdentifier","preciseIdentifier":"s:Su","text":"UInt"},{"kind":"text","text":") "},{"text":"rethrows","kind":"keyword"}],"title":"assert(_:fileID:file:line:column:)","abstract":[],"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/assert(_:fileID:file:line:column:)","role":"symbol","type":"topic","kind":"symbol"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/PersistenceReaderKey/inMemory(_:)":{"title":"inMemory(_:)","role":"symbol","url":"\/documentation\/composablearchitecture\/persistencereaderkey\/inmemory(_:)","kind":"symbol","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/inMemory(_:)","type":"topic","fragments":[{"kind":"keyword","text":"static"},{"text":" ","kind":"text"},{"text":"func","kind":"keyword"},{"kind":"text","text":" "},{"text":"inMemory","kind":"identifier"},{"kind":"text","text":"<"},{"kind":"genericParameter","text":"Value"},{"kind":"text","text":">("},{"text":"String","kind":"typeIdentifier","preciseIdentifier":"s:SS"},{"text":") -> ","kind":"text"},{"text":"Self","kind":"typeIdentifier"}],"abstract":[{"type":"text","text":"Creates a persistence key for sharing data in-memory for the lifetime of an application."}]},"#Custom-persistence":{"title":"Custom persistence","identifier":"#Custom-persistence","titleInlineContent":[{"type":"text","text":"Custom persistence"}],"url":"#Custom-persistence","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/PersistenceKey":{"navigatorTitle":[{"kind":"identifier","text":"PersistenceKey"}],"url":"\/documentation\/composablearchitecture\/persistencekey","abstract":[{"type":"text","text":"A type that can persist shared state to an external storage."}],"fragments":[{"text":"protocol","kind":"keyword"},{"kind":"text","text":" "},{"kind":"identifier","text":"PersistenceKey"}],"kind":"symbol","title":"PersistenceKey","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceKey","role":"symbol","type":"topic"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Reducer":{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Reducer","kind":"symbol","type":"topic","abstract":[{"text":"A protocol that describes how to evolve the current state of an application to the next state,","type":"text"},{"type":"text","text":" "},{"text":"given an action, and describes what ","type":"text"},{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Effect","type":"reference","isActive":true},{"text":"s should be executed later by the store, if any.","type":"text"}],"fragments":[{"text":"protocol","kind":"keyword"},{"text":" ","kind":"text"},{"text":"Reducer","kind":"identifier"}],"title":"Reducer","navigatorTitle":[{"text":"Reducer","kind":"identifier"}],"url":"\/documentation\/composablearchitecture\/reducer","role":"symbol"},"#Read-only-shared-state":{"title":"Read-only shared state","identifier":"#Read-only-shared-state","titleInlineContent":[{"type":"text","text":"Read-only shared state"}],"url":"#Read-only-shared-state","type":"link"},"#Explicit-shared-state":{"title":"Explicit shared state","identifier":"#Explicit-shared-state","titleInlineContent":[{"type":"text","text":"Explicit shared state"}],"url":"#Explicit-shared-state","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Testing#Testing-gotchas":{"title":"Testing gotchas","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Testing#Testing-gotchas","abstract":[],"url":"\/documentation\/composablearchitecture\/testing#Testing-gotchas","kind":"section","type":"topic"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Dependencies/DependencyValues/defaultFileStorage":{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Dependencies\/DependencyValues\/defaultFileStorage","title":"defaultFileStorage","url":"\/documentation\/composablearchitecture\/dependencies\/dependencyvalues\/defaultfilestorage","role":"symbol","type":"topic","kind":"symbol","fragments":[{"text":"var","kind":"keyword"},{"kind":"text","text":" "},{"text":"defaultFileStorage","kind":"identifier"},{"text":": ","kind":"text"},{"kind":"typeIdentifier","text":"FileStorage","preciseIdentifier":"s:22ComposableArchitecture11FileStorageV"}],"abstract":[{"type":"text","text":"Default file storage used by "},{"type":"reference","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey\/fileStorage(_:decoder:encoder:)","isActive":true},{"text":".","type":"text"}]},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Shared/elements":{"conformance":{"conformancePrefix":[{"type":"text","text":"Conforms when"}],"constraints":[{"code":"Value","type":"codeVoice"},{"text":" conforms to ","type":"text"},{"type":"codeVoice","code":"_MutableIdentifiedCollection"},{"type":"text","text":", "},{"type":"codeVoice","code":"Value"},{"text":" conforms to ","type":"text"},{"type":"codeVoice","code":"Sendable"},{"type":"text","text":", and "},{"code":"Value.Element","type":"codeVoice"},{"type":"text","text":" conforms to "},{"code":"Sendable","type":"codeVoice"},{"text":".","type":"text"}],"availabilityPrefix":[{"type":"text","text":"Available when"}]},"url":"\/documentation\/composablearchitecture\/shared\/elements","fragments":[{"text":"var","kind":"keyword"},{"text":" ","kind":"text"},{"text":"elements","kind":"identifier"},{"text":": ","kind":"text"},{"kind":"keyword","text":"some"},{"kind":"text","text":" "},{"kind":"typeIdentifier","preciseIdentifier":"s:Sk","text":"RandomAccessCollection"},{"text":"<","kind":"text"},{"text":"Shared","kind":"typeIdentifier","preciseIdentifier":"s:22ComposableArchitecture6SharedV"},{"text":"<","kind":"text"},{"text":"Value","kind":"typeIdentifier"},{"text":".","kind":"text"},{"text":"Element","kind":"typeIdentifier","preciseIdentifier":"s:ST7ElementQa"},{"kind":"text","text":">>"}],"title":"elements","abstract":[{"text":"Allows a ","type":"text"},{"code":"ForEach","type":"codeVoice"},{"type":"text","text":" view to transform a shared collection into shared elements."}],"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/elements","role":"symbol","type":"topic","kind":"symbol"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/SharingState#Testing":{"title":"Testing","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState#Testing","abstract":[],"url":"\/documentation\/composablearchitecture\/sharingstate#Testing","kind":"section","type":"topic"},"#Gotchas-of-Shared":{"title":"Gotchas of @Shared","identifier":"#Gotchas-of-Shared","titleInlineContent":[{"type":"text","text":"Gotchas of @Shared"}],"url":"#Gotchas-of-Shared","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/ObservableState()":{"abstract":[{"text":"Defines and implements conformance of the Observable protocol.","type":"text"}],"role":"symbol","kind":"symbol","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/ObservableState()","fragments":[{"text":"macro","kind":"keyword"},{"kind":"text","text":" "},{"kind":"identifier","text":"ObservableState"},{"kind":"text","text":"()"}],"type":"topic","title":"ObservableState()","url":"\/documentation\/composablearchitecture\/observablestate()"},"doc://ComposableArchitecture/documentation/ComposableArchitecture":{"title":"ComposableArchitecture","url":"\/documentation\/composablearchitecture","abstract":[{"type":"text","text":"The Composable Architecture (TCA, for short) is a library for building applications in a consistent"},{"type":"text","text":" "},{"type":"text","text":"and understandable way, with composition, testing, and ergonomics in mind. It can be used in"},{"text":" ","type":"text"},{"type":"text","text":"SwiftUI, UIKit, and more, and on any Apple platform (iOS, macOS, tvOS, and watchOS)."}],"role":"collection","type":"topic","kind":"symbol","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/FAQ":{"abstract":[{"type":"text","text":"A collection of some of the most common questions and comments people have concerning the library."}],"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/FAQ","title":"Frequently asked questions","role":"article","kind":"article","url":"\/documentation\/composablearchitecture\/faq","type":"topic"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/DependencyManagement":{"type":"topic","url":"\/documentation\/composablearchitecture\/dependencymanagement","title":"Dependencies","abstract":[{"text":"Learn how to register dependencies with the library so that they can be immediately accessible from","type":"text"},{"type":"text","text":" "},{"type":"text","text":"any reducer."}],"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/DependencyManagement","role":"article","kind":"article"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/SharingState#Read-only-shared-state":{"kind":"section","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState#Read-only-shared-state","url":"\/documentation\/composablearchitecture\/sharingstate#Read-only-shared-state","abstract":[],"type":"topic","title":"Read-only shared state"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/SharedReader":{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharedReader","url":"\/documentation\/composablearchitecture\/sharedreader","title":"SharedReader","role":"symbol","abstract":[{"text":"A property wrapper type that shares a value with multiple parts of an application.","type":"text"}],"fragments":[{"kind":"keyword","text":"struct"},{"text":" ","kind":"text"},{"kind":"identifier","text":"SharedReader"}],"type":"topic","kind":"symbol","navigatorTitle":[{"kind":"identifier","text":"SharedReader"}]},"#Testing-tips":{"title":"Testing tips","identifier":"#Testing-tips","titleInlineContent":[{"type":"text","text":"Testing tips"}],"url":"#Testing-tips","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/PersistenceReaderKey":{"navigatorTitle":[{"text":"PersistenceReaderKey","kind":"identifier"}],"url":"\/documentation\/composablearchitecture\/persistencereaderkey","abstract":[{"text":"A type that can load and subscribe to state in an external system.","type":"text"}],"fragments":[{"kind":"keyword","text":"protocol"},{"text":" ","kind":"text"},{"kind":"identifier","text":"PersistenceReaderKey"}],"kind":"symbol","title":"PersistenceReaderKey","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/PersistenceReaderKey","role":"symbol","type":"topic"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Performance":{"type":"topic","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Performance","abstract":[{"text":"Learn how to improve the performance of features built in the Composable Architecture.","type":"text"}],"kind":"article","url":"\/documentation\/composablearchitecture\/performance","title":"Performance","role":"article"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/SharingState#Gotchas-of-Shared":{"title":"Gotchas of @Shared","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState#Gotchas-of-Shared","abstract":[],"url":"\/documentation\/composablearchitecture\/sharingstate#Gotchas-of-Shared","kind":"section","type":"topic"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Shared/subscript(dynamicMember:)-9xw64":{"deprecated":true,"role":"symbol","type":"topic","abstract":[],"kind":"symbol","title":"subscript(dynamicMember:)","url":"\/documentation\/composablearchitecture\/shared\/subscript(dynamicmember:)-9xw64","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/subscript(dynamicMember:)-9xw64","fragments":[{"text":"subscript","kind":"keyword"},{"kind":"text","text":"<"},{"text":"Member","kind":"genericParameter"},{"text":">(","kind":"text"},{"text":"dynamicMember","kind":"externalParam"},{"text":" _: ","kind":"text"},{"text":"WritableKeyPath","kind":"typeIdentifier","preciseIdentifier":"s:s15WritableKeyPathC"},{"text":"<","kind":"text"},{"text":"Value","kind":"typeIdentifier"},{"kind":"text","text":", "},{"kind":"typeIdentifier","text":"Member"},{"kind":"text","text":"?>) -> "},{"text":"Shared","kind":"typeIdentifier","preciseIdentifier":"s:22ComposableArchitecture6SharedV"},{"kind":"text","text":"<"},{"text":"Member","kind":"typeIdentifier"},{"kind":"text","text":">?"}]},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Effect":{"navigatorTitle":[{"text":"Effect","kind":"identifier"}],"type":"topic","title":"Effect","abstract":[],"kind":"symbol","role":"symbol","url":"\/documentation\/composablearchitecture\/effect","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Effect","fragments":[{"text":"struct","kind":"keyword"},{"text":" ","kind":"text"},{"text":"Effect","kind":"identifier"}]},"https://github.com/apple/swift/issues/74203":{"title":"known issue","identifier":"https:\/\/github.com\/apple\/swift\/issues\/74203","titleInlineContent":[{"type":"text","text":"known issue"}],"url":"https:\/\/github.com\/apple\/swift\/issues\/74203","type":"link"},"#User-defaults":{"title":"User defaults","identifier":"#User-defaults","titleInlineContent":[{"type":"text","text":"User defaults"}],"url":"#User-defaults","type":"link"},"#Observing-changes-to-shared-state":{"title":"Observing changes to shared state","identifier":"#Observing-changes-to-shared-state","titleInlineContent":[{"type":"text","text":"Observing changes to shared state"}],"url":"#Observing-changes-to-shared-state","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/TestStore":{"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/TestStore","kind":"symbol","title":"TestStore","role":"symbol","navigatorTitle":[{"text":"TestStore","kind":"identifier"}],"url":"\/documentation\/composablearchitecture\/teststore","fragments":[{"text":"class","kind":"keyword"},{"kind":"text","text":" "},{"text":"TestStore","kind":"identifier"}],"abstract":[{"text":"A testable runtime for a reducer.","type":"text"}],"type":"topic"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Shared/projectedValue":{"role":"symbol","type":"topic","url":"\/documentation\/composablearchitecture\/shared\/projectedvalue","kind":"symbol","title":"projectedValue","fragments":[{"text":"var","kind":"keyword"},{"text":" ","kind":"text"},{"text":"projectedValue","kind":"identifier"},{"text":": ","kind":"text"},{"kind":"typeIdentifier","preciseIdentifier":"s:22ComposableArchitecture6SharedV","text":"Shared"},{"text":"<","kind":"text"},{"text":"Value","kind":"typeIdentifier"},{"text":">","kind":"text"}],"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/projectedValue","abstract":[{"type":"text","text":"A projection of the shared value that returns a shared reference."}]},"doc://ComposableArchitecture/documentation/ComposableArchitecture/SharingState#Initialization-rules":{"title":"Initialization rules","identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/SharingState#Initialization-rules","abstract":[],"url":"\/documentation\/composablearchitecture\/sharingstate#Initialization-rules","kind":"section","type":"topic"},"#Overriding-shared-state-in-tests":{"title":"Overriding shared state in tests","identifier":"#Overriding-shared-state-in-tests","titleInlineContent":[{"type":"text","text":"Overriding shared state in tests"}],"url":"#Overriding-shared-state-in-tests","type":"link"},"doc://ComposableArchitecture/documentation/ComposableArchitecture/Shared/init(wrappedValue:_:fileID:line:)-9kfmy":{"title":"init(wrappedValue:_:fileID:line:)","abstract":[{"text":"Creates a shared reference to a value using a persistence key.","type":"text"}],"type":"topic","kind":"symbol","fragments":[{"text":"init","kind":"identifier"},{"text":"(","kind":"text"},{"text":"wrappedValue","kind":"externalParam"},{"kind":"text","text":": "},{"text":"@autoclosure ","kind":"attribute"},{"text":"() -> ","kind":"text"},{"kind":"typeIdentifier","text":"Value"},{"text":", some ","kind":"text"},{"preciseIdentifier":"s:22ComposableArchitecture14PersistenceKeyP","text":"PersistenceKey","kind":"typeIdentifier"},{"text":"<","kind":"text"},{"text":"Value","kind":"typeIdentifier"},{"kind":"text","text":">, "},{"text":"fileID","kind":"externalParam"},{"text":": ","kind":"text"},{"kind":"typeIdentifier","preciseIdentifier":"s:s12StaticStringV","text":"StaticString"},{"text":", ","kind":"text"},{"kind":"externalParam","text":"line"},{"text":": ","kind":"text"},{"text":"UInt","preciseIdentifier":"s:Su","kind":"typeIdentifier"},{"text":")","kind":"text"}],"identifier":"doc:\/\/ComposableArchitecture\/documentation\/ComposableArchitecture\/Shared\/init(wrappedValue:_:fileID:line:)-9kfmy","role":"symbol","conformance":{"availabilityPrefix":[{"type":"text","text":"Available when"}],"constraints":[{"type":"codeVoice","code":"Value"},{"type":"text","text":" conforms to "},{"type":"codeVoice","code":"Sendable"},{"text":".","type":"text"}],"conformancePrefix":[{"text":"Conforms when","type":"text"}]},"url":"\/documentation\/composablearchitecture\/shared\/init(wrappedvalue:_:fileid:line:)-9kfmy"}}}